
@{
    Layout = null;
}

<!DOCTYPE html>

@{
    ViewData["Title"] = "Chat";
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Chat App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            height: 90vh;
            overflow: auto;
            background: #fff;
            border-radius: 10px 0 0 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chat-panel {
            height: 90vh;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .messages {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #e3f2fd 0%, #f5f5f5 100%);
        }

        .message-row {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
        }

        .message-me {
            justify-content: flex-end;
        }

        .msg-bubble {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .msg-bubble.me {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .msg-bubble.other {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .msg-bubble.unread {
            border-left: 4px solid #667eea;
            font-weight: 500;
        }

        .msg-status {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.8;
        }

        .msg-status i {
            margin-left: 4px;
        }

        .contact-item {
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .contact-item:hover {
            background: #f0f0f0;
            border-left-color: #667eea;
        }

        .contact-item.active {
            background: #e3f2fd;
            border-left-color: #667eea;
        }

        .typing {
            color: #667eea;
            font-style: italic;
            font-size: 14px;
        }

        .topbar {
            padding: 15px 20px;
            border-bottom: 2px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0 10px 0 0;
        }

        .sidebar .topbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px 0 0 0;
        }

        .file-preview {
            margin-top: 8px;
            max-width: 100%;
        }

        .file-preview img, .file-preview video {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            cursor: pointer;
        }

        .file-download {
            display: inline-block;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s;
        }

        .msg-bubble.me .file-download {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .file-download:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .file-download i {
            margin-right: 5px;
        }

        #fileInput {
            display: none;
        }

        .btn-file {
            background: none;
            border: none;
            color: #667eea;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-file:hover {
            transform: scale(1.2);
            color: #764ba2;
        }

        .modal-backdrop {
            background: rgba(0,0,0,0.8);
        }

        #previewModal .modal-dialog {
            max-width: 90%;
        }

        #previewModal img, #previewModal video {
            max-width: 100%;
            max-height: 80vh;
            margin: auto;
            display: block;
        }

        .input-group {
            background: white;
            border-radius: 25px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .input-group input {
            border: none;
            border-radius: 20px;
        }

        .input-group input:focus {
            box-shadow: none;
        }

        #sendBtn {
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .unread-badge {
            background: #f44336;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="row shadow-lg">
            <div class="col-md-4 sidebar p-0">
                <div class="topbar d-flex justify-content-between align-items-center">
                    <div><strong><i class="fas fa-comments"></i> Chats</strong></div>
                    <div>
                        <a href="/Account/Logout" class="btn btn-sm btn-light"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>

                <div class="p-3">
                    <input id="searchInput" class="form-control mb-3" placeholder="🔍 Search contacts/groups" />
                    <div class="d-flex gap-2 mb-3">
                        <input id="groupInput" class="form-control" placeholder="Group name" />
                        <button id="joinGroupBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> Join</button>
                    </div>
                </div>

                <div>
                    <h6 class="px-3 mb-2 text-muted"><i class="fas fa-users"></i> People</h6>
                    <ul id="usersList" class="list-group list-group-flush"></ul>
                </div>

                <div class="mt-3">
                    <h6 class="px-3 mb-2 text-muted"><i class="fas fa-layer-group"></i> Groups</h6>
                    <ul id="groupsList" class="list-group list-group-flush"></ul>
                </div>
            </div>

            <div class="col-md-8 chat-panel">
                <div class="topbar d-flex justify-content-between align-items-center">
                    <div>
                        <strong id="targetLabel"><i class="fas fa-globe"></i> Public</strong>
                        <button id="voiceCallBtn" class="btn btn-sm btn-light ms-3"><i class="fas fa-phone"></i> Voice</button>
                        <button id="videoCallBtn" class="btn btn-sm btn-light"><i class="fas fa-video"></i> Video</button>
                    </div>
                    <div class="small">Welcome, <strong>@User.Identity!.Name</strong></div>
                </div>

                <div id="messages" class="messages"></div>

                <div class="p-3 bg-white">
                    <div id="typingIndicator" class="typing mb-2"></div>
                    <div class="input-group">
                        <button class="btn-file" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="file" id="fileInput" accept="image/*,video/*,.pdf,.doc,.docx" />
                        <input id="messageInput" class="form-control" placeholder="Type a message..." />
                        <button id="sendBtn" class="btn btn-success px-4"><i class="fas fa-paper-plane"></i> Send</button>
                    </div>
                    <div id="filePreviewContainer" class="mt-2" style="display:none;">
                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                            <span id="filePreviewText"></span>
                            <button class="btn btn-sm btn-danger" onclick="clearFileSelection()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incoming call modal -->
    <div id="incomingCallModal" class="modal" tabindex="-1" style="display:none;">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body">
                    <p id="incomingCallText">Incoming call...</p>
                    <div class="d-flex justify-content-between">
                        <button id="acceptCallBtn" class="btn btn-success"><i class="fas fa-phone"></i> Accept</button>
                        <button id="rejectCallBtn" class="btn btn-danger"><i class="fas fa-phone-slash"></i> Reject</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Call area -->
    <div id="callContainer" style="display:none; position:fixed; right:20px; bottom:20px; width:360px; z-index:1050;">
        <div class="card shadow-lg">
            <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                <span id="callWithLabel"><i class="fas fa-phone"></i> Call with ...</span>
                <button id="hangupBtn" class="btn btn-sm btn-danger"><i class="fas fa-phone-slash"></i> Hang up</button>
            </div>
            <div class="card-body p-0">
                <video id="remoteVideo" autoplay playsinline style="width:100%; background:#000;"></video>
                <video id="localVideo" autoplay muted playsinline style="width:80px; position:absolute; right:10px; bottom:60px; border:2px solid #fff; border-radius:8px;"></video>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">File Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center" id="previewModalBody">
                </div>
                <div class="modal-footer">
                    <a id="previewDownloadBtn" href="#" download class="btn btn-primary"><i class="fas fa-download"></i> Download</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
    const currentUser = "@User.Identity!.Name";
    let connection = null;
    window.selectedTarget = { type: 'public', name: null };
    const usersListEl = document.getElementById('usersList');
    const groupsListEl = document.getElementById('groupsList');
    const messagesEl = document.getElementById('messages');
    const targetLabel = document.getElementById('targetLabel');
    const typingEl = document.getElementById('typingIndicator');
    let selectedFile = null;

    async function init() {
      connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .withAutomaticReconnect()
        .build();

      connection.on("UsersUpdated", (users) => renderUsers(users));

      connection.on("ReceiveMessage", (user, text, ts, msgId, fileUrl, fileName, fileType, fileSize) => {
        if (selectedTarget.type === 'public') {
          appendMessage(user, text, ts, user === currentUser, msgId, fileUrl, fileName, fileType, fileSize, true);
        }
      });

      connection.on("ReceivePrivateMessage", (fromUser, toUser, text, ts, msgId, fileUrl, fileName, fileType, fileSize, isRead) => {
        const isRelevant = (selectedTarget.type === 'user' && (selectedTarget.name === fromUser || selectedTarget.name === toUser));
        if (isRelevant) {
          appendMessage(fromUser, text, ts, fromUser === currentUser, msgId, fileUrl, fileName, fileType, fileSize, isRead);
          // Mark as read if I'm the recipient
          if (toUser === currentUser && fromUser !== currentUser) {
            connection.invoke('MarkMessageAsRead', msgId, fromUser);
          }
        }
      });

      connection.on("ReceiveGroupMessage", (user, groupName, text, ts, msgId, fileUrl, fileName, fileType, fileSize) => {
        if (selectedTarget.type === 'group' && selectedTarget.name === groupName) {
          appendMessage(user, text, ts, user === currentUser, msgId, fileUrl, fileName, fileType, fileSize, true);
        }
      });

      connection.on("MessageRead", (msgId) => {
        const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
        if (msgEl) {
          const statusEl = msgEl.querySelector('.msg-status');
          if (statusEl) {
            statusEl.innerHTML = '<i class="fas fa-check-double" style="color:#4caf50;"></i> Read';
          }
        }
      });

      connection.on("GroupSystemMessage", (text, ts) => appendSystem(text, ts));
      connection.on("UserTyping", (fromUser, toUser) => {
        if (selectedTarget.type === 'user' && selectedTarget.name === fromUser) showTyping(`${fromUser} is typing...`);
      });
      connection.on("GroupTyping", (fromUser, groupName) => {
        if (selectedTarget.type === 'group' && selectedTarget.name === groupName) showTyping(`${fromUser} is typing...`);
      });

      await connection.start();
      await loadLists();
      await loadConversation('public', null);
    }

    function appendSystem(text, ts) {
      const div = document.createElement('div');
      div.className = 'message-row text-center text-muted small';
      div.innerHTML = `<i class="fas fa-info-circle"></i> [${new Date(ts).toLocaleTimeString()}] ${text}`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function appendMessage(user, text, ts, isMe, msgId, fileUrl, fileName, fileType, fileSize, isRead) {
      const row = document.createElement('div');
      row.className = 'message-row ' + (isMe ? 'message-me' : '');
      row.setAttribute('data-msg-id', msgId);

      const bubble = document.createElement('div');
      bubble.className = 'msg-bubble ' + (isMe ? 'me' : 'other');
      if (!isMe && !isRead) bubble.classList.add('unread');

      let content = `<div class="small" style="opacity:0.8;margin-bottom:4px;"><strong>${user}</strong></div>`;

      if (text) {
        content += `<div>${escapeHtml(text)}</div>`;
      }

      if (fileUrl) {
        content += `<div class="file-preview">`;
        if (fileType === 'image') {
          content += `<img src="${fileUrl}" alt="${fileName}" onclick="showPreview('${fileUrl}', '${fileName}', '${fileType}')" />`;
        } else if (fileType === 'video') {
          content += `<video controls src="${fileUrl}" onclick="showPreview('${fileUrl}', '${fileName}', '${fileType}')"></video>`;
        }
        content += `<br/><a href="${fileUrl}" download="${fileName}" class="file-download">
                      <i class="fas fa-download"></i> ${fileName} (${formatFileSize(fileSize)})
                    </a>`;
        content += `</div>`;
      }

      content += `<div class="small mt-1" style="opacity:0.7;">${new Date(ts).toLocaleTimeString()}</div>`;

      if (isMe) {
        content += `<div class="msg-status small">
                      <i class="fas fa-check"></i> ${isRead ? '<i class="fas fa-check-double" style="color:#4caf50;"></i> Read' : 'Sent'}
                    </div>`;
      }

      bubble.innerHTML = content;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function escapeHtml(s){ 
      if (!s) return '';
      return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); 
    }

    function showTyping(t) {
      typingEl.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> ${t}`;
      setTimeout(()=> typingEl.textContent = '', 2000);
    }

    async function loadLists() {
      const users = await fetch('/Home/GetUsers').then(r=>r.json());
      renderUsers(users.map(u=>u.username || u.Username || u));
      const groups = await fetch('/Home/GetMyGroups').then(r=>r.json());
      renderGroups(groups.map(g => g.name || g.Name));
    }

    function renderUsers(users) {
      usersListEl.innerHTML = '';
      users.forEach(u => {
        const li = document.createElement('li');
        li.className = 'list-group-item contact-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<span><span class="online-indicator"></span>${u}${u === currentUser ? ' (you)' : ''}</span>`;
        li.addEventListener('click', ()=> selectUser(u));
        usersListEl.appendChild(li);
      });
    }

    function renderGroups(groups) {
      groupsListEl.innerHTML = '';
      groups.forEach(g => {
        const li = document.createElement('li');
        li.className = 'list-group-item contact-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<span><i class="fas fa-users"></i> ${g}</span>`;
        li.addEventListener('click', ()=> selectGroup(g));
        const leaveBtn = document.createElement('button');
        leaveBtn.className = 'btn btn-sm btn-outline-danger';
        leaveBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Leave';
        leaveBtn.addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          await connection.invoke('LeaveGroup', g);
          await loadLists();
          selectPublic();
        });
        li.appendChild(leaveBtn);
        groupsListEl.appendChild(li);
      });
    }

    async function selectUser(u) {
      window.selectedTarget = { type: 'user', name: u };
      targetLabel.innerHTML = `<i class="fas fa-user"></i> Chat: ${u}`;
      messagesEl.innerHTML = '';
      await loadConversation('user', u);
      setActiveContact(u, 'user');
    }

    async function selectGroup(g) {
      window.selectedTarget = { type: 'group', name: g };
      targetLabel.innerHTML = `<i class="fas fa-users"></i> Group: ${g}`;
      messagesEl.innerHTML = '';
      await loadConversation('group', g);
      setActiveContact(g, 'group');
    }

    async function selectPublic() {
      window.selectedTarget = { type: 'public', name: null };
      targetLabel.innerHTML = '<i class="fas fa-globe"></i> Public';
      messagesEl.innerHTML = '';
      await loadConversation('public', null);
      setActiveContact(null, 'public');
    }

    function setActiveContact(name, type) {
      document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
      if (type === 'user' || type === 'group') {
        const items = type === 'user' ? usersListEl.children : groupsListEl.children;
        Array.from(items).forEach(li => {
          if (li.textContent.includes(name)) li.classList.add('active');
        });
      }
    }

    async function loadConversation(type, name){
      const url = `/Home/GetConversation?type=${encodeURIComponent(type)}${name?`&name=${encodeURIComponent(name)}`:''}`;
      const data = await fetch(url).then(r=>r.json());
      messagesEl.innerHTML = '';
      for (const m of data) {
        const from = m.from || m.From;
        const text = m.text || m.Text;
        const ts = m.timestampUtc || m.TimestampUtc;
        const msgId = m.id || m.Id;
        const fileUrl = m.fileUrl || m.FileUrl;
        const fileName = m.fileName || m.FileName;
        const fileType = m.fileType || m.FileType;
        const fileSize = m.fileSize || m.FileSize;
        const isRead = m.isRead || m.IsRead;
        appendMessage(from, text, ts, from === currentUser, msgId, fileUrl, fileName, fileType, fileSize, isRead);
      }
    }

    document.getElementById('joinGroupBtn').addEventListener('click', async ()=>{
      const g = document.getElementById('groupInput').value.trim();
      if (!g) return alert('Enter group name');
      await connection.invoke('JoinGroup', g);
      await loadLists();
      selectGroup(g);
    });

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', (e)=>{
      if (e.key==='Enter'){ e.preventDefault(); sendMessage(); return; }
      notifyTyping();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      selectedFile = e.target.files[0];
      if (selectedFile) {
        document.getElementById('filePreviewContainer').style.display = 'block';
        document.getElementById('filePreviewText').textContent = `Selected: ${selectedFile.name} (${formatFileSize(selectedFile.size)})`;
      }
    });

    function clearFileSelection() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('filePreviewContainer').style.display = 'none';
    }

    async function sendMessage(){
      const text = document.getElementById('messageInput').value.trim();

      if (!text && !selectedFile) return;

      if (selectedFile) {
        // Upload file first
        const formData = new FormData();
        formData.append('file', selectedFile);

        try {
          const response = await fetch('/Home/UploadFile', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.fileUrl) {
            // Send message with file
            if (selectedTarget.type === 'public') {
              await connection.invoke('SendFileToAll', text, result.fileUrl, result.fileName, result.fileType, result.fileSize);
            } else if (selectedTarget.type === 'user') {
              await connection.invoke('SendPrivateFileMessage', selectedTarget.name, text, result.fileUrl, result.fileName, result.fileType, result.fileSize);
            } else if (selectedTarget.type === 'group') {
              await connection.invoke('SendFileToGroup', selectedTarget.name, text, result.fileUrl, result.fileName, result.fileType, result.fileSize);
            }
          }
        } catch (err) {
          alert('Failed to upload file: ' + err);
        }

        clearFileSelection();
      } else {
        // Send text-only message
        if (selectedTarget.type === 'public') await connection.invoke('SendMessageToAll', text);
        else if (selectedTarget.type === 'user') await connection.invoke('SendPrivateMessage', selectedTarget.name, text);
        else if (selectedTarget.type === 'group') await connection.invoke('SendMessageToGroup', selectedTarget.name, text);
      }

      document.getElementById('messageInput').value = '';
    }

    let typingTimeout = null;
    function notifyTyping(){
      if (!connection) return;
      if (selectedTarget.type === 'user') connection.invoke('TypingToUser', selectedTarget.name).catch(()=>{});
      else if (selectedTarget.type === 'group') connection.invoke('TypingToGroup', selectedTarget.name).catch(()=>{});
    }

    function showPreview(fileUrl, fileName, fileType) {
      const modalBody = document.getElementById('previewModalBody');
      modalBody.innerHTML = '';

      if (fileType === 'image') {
        modalBody.innerHTML = `<img src="${fileUrl}" alt="${fileName}" style="max-width:100%;" />`;
      } else if (fileType === 'video') {
        modalBody.innerHTML = `<video controls src="${fileUrl}" style="max-width:100%;"></video>`;
      }

      document.getElementById('previewDownloadBtn').href = fileUrl;
      document.getElementById('previewDownloadBtn').download = fileName;
      document.getElementById('previewModalLabel').textContent = fileName;

      new bootstrap.Modal(document.getElementById('previewModal')).show();
    }

    init().catch(err => console.error(err));
    </script>

    <script src="~/js/call.js"></script>
</body>
</html>