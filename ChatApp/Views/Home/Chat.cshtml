@{
    ViewData["Title"] = "Chat";
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Chat App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: #e5ddd5;
        }

        .sidebar {
            height: 85vh;
            overflow: auto;
            background: #f7f7f7;
            border-right: 1px solid #ddd;
        }

        .chat-panel {
            height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #fff;
        }

        .message-row {
            margin-bottom: 10px;
        }

        .message-me {
            text-align: right;
        }

        .msg-bubble {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 16px;
            max-width: 70%;
        }

            .msg-bubble.me {
                background: #dcf8c6;
            }

            .msg-bubble.other {
                background: #fff;
                border: 1px solid #eee;
            }

        .contact-item {
            cursor: pointer;
        }

        .typing {
            color: #777;
            font-style: italic;
        }

        .topbar {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            background: #fff;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-3">
        <div class="row shadow-sm">
            <div class="col-md-4 sidebar p-0">
                <div class="topbar d-flex justify-content-between align-items-center">
                    <div><strong>Chats</strong></div>
                    <div>
                        <a href="/Account/Logout" class="btn btn-sm btn-outline-secondary">Logout</a>
                    </div>
                </div>

                <div class="p-2">
                    <input id="searchInput" class="form-control mb-2" placeholder="Search contacts/groups" />
                    <div class="d-flex gap-2 mb-2">
                        <input id="groupInput" class="form-control" placeholder="Group name" />
                        <button id="joinGroupBtn" class="btn btn-primary">Join</button>
                    </div>
                </div>

                <div>
                    <h6 class="px-3 mb-1">People</h6>
                    <ul id="usersList" class="list-group list-group-flush"></ul>
                </div>

                <div class="mt-3">
                    <h6 class="px-3 mb-1">Groups</h6>
                    <ul id="groupsList" class="list-group list-group-flush"></ul>
                </div>
            </div>

            <div class="col-md-8 chat-panel">
                <div class="topbar d-flex justify-content-between align-items-center">
                    <div><strong id="targetLabel">Public</strong></div>
                    <div class="small text-muted">Welcome, @User.Identity!.Name</div>
                </div>

                <div id="messages" class="messages"></div>

                <div class="p-3 bg-white">
                    <div id="typingIndicator" class="typing mb-1"></div>
                    <div class="input-group">
                        <input id="messageInput" class="form-control" placeholder="Type a message" />
                        <button id="sendBtn" class="btn btn-success">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
    const currentUser = "@User.Identity!.Name";
    let connection = null;
    let selectedTarget = { type: 'public', name: null };
    const usersListEl = document.getElementById('usersList');
    const groupsListEl = document.getElementById('groupsList');
    const messagesEl = document.getElementById('messages');
    const targetLabel = document.getElementById('targetLabel');
    const typingEl = document.getElementById('typingIndicator');

    async function init() {
      connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .withAutomaticReconnect()
        .build();

      connection.on("UsersUpdated", (users) => renderUsers(users));
      connection.on("ReceiveMessage", (user, text, ts) => {
        if (selectedTarget.type === 'public') appendMessage(user, text, ts, user === currentUser);
      });
      connection.on("ReceivePrivateMessage", (fromUser, toUser, text, ts) => {
        // whether this message belongs to current conversation
        const isRelevant = (selectedTarget.type === 'user' && (selectedTarget.name === fromUser || selectedTarget.name === toUser));
        if (isRelevant) appendMessage(fromUser, text, ts, fromUser === currentUser);
      });
      connection.on("ReceiveGroupMessage", (user, groupName, text, ts) => {
        if (selectedTarget.type === 'group' && selectedTarget.name === groupName) appendMessage(user, text, ts, user === currentUser);
      });
      connection.on("GroupSystemMessage", (text, ts) => appendSystem(text, ts));
      connection.on("UserTyping", (fromUser, toUser) => {
        if (selectedTarget.type === 'user' && selectedTarget.name === fromUser) showTyping(`${fromUser} is typing...`);
      });
      connection.on("GroupTyping", (fromUser, groupName) => {
        if (selectedTarget.type === 'group' && selectedTarget.name === groupName) showTyping(`${fromUser} is typing...`);
      });

      await connection.start();
      await loadLists();
      await loadConversation('public', null);
    }

    function appendSystem(text, ts) {
      const div = document.createElement('div');
      div.className = 'message-row text-center text-muted small';
      div.textContent = `[${new Date(ts).toLocaleTimeString()}] ${text}`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function appendMessage(user, text, ts, isMe) {
      const row = document.createElement('div');
      row.className = 'message-row ' + (isMe ? 'message-me' : '');
      const bubble = document.createElement('div');
      bubble.className = 'msg-bubble ' + (isMe ? 'me' : 'other');
      bubble.innerHTML = `<div class="small text-muted">${user}</div><div>${escapeHtml(text)}</div><div class="small text-muted mt-1">${new Date(ts).toLocaleTimeString()}</div>`;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function showTyping(t) {
      typingEl.textContent = t;
      setTimeout(()=> typingEl.textContent = '', 1500);
    }

    async function loadLists() {
      const users = await fetch('/Home/GetUsers').then(r=>r.json());
      renderUsers(users.map(u=>u.username || u.Username || u));
      const groups = await fetch('/Home/GetMyGroups').then(r=>r.json());
      renderGroups(groups.map(g => g.name || g.Name));
    }

    function renderUsers(users) {
      usersListEl.innerHTML = '';
      users.forEach(u => {
        const li = document.createElement('li');
        li.className = 'list-group-item contact-item d-flex justify-content-between align-items-center';
        li.textContent = u + (u === currentUser ? ' (you)' : '');
        li.addEventListener('click', ()=> selectUser(u));
        usersListEl.appendChild(li);
      });
    }

    function renderGroups(groups) {
      groupsListEl.innerHTML = '';
      groups.forEach(g => {
        const li = document.createElement('li');
        li.className = 'list-group-item contact-item d-flex justify-content-between align-items-center';
        li.textContent = g;
        li.addEventListener('click', ()=> selectGroup(g));
        const leaveBtn = document.createElement('button');
        leaveBtn.className = 'btn btn-sm btn-outline-danger';
        leaveBtn.textContent = 'Leave';
        leaveBtn.addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          await connection.invoke('LeaveGroup', g);
          await loadLists();
          selectPublic();
        });
        li.appendChild(leaveBtn);
        groupsListEl.appendChild(li);
      });
    }

    async function selectUser(u) {
      selectedTarget = { type:'user', name: u };
      targetLabel.textContent = `Chat: ${u}`;
      messagesEl.innerHTML = '';
      await loadConversation('user', u);
    }

    async function selectGroup(g) {
      selectedTarget = { type:'group', name: g };
      targetLabel.textContent = `Group: ${g}`;
      messagesEl.innerHTML = '';
      await loadConversation('group', g);
    }

    async function selectPublic() {
      selectedTarget = { type:'public', name: null };
      targetLabel.textContent = 'Public';
      messagesEl.innerHTML = '';
      await loadConversation('public', null);
    }

    async function loadConversation(type, name){
      const url = `/Home/GetConversation?type=${encodeURIComponent(type)}${name?`&name=${encodeURIComponent(name)}`:''}`;
      const data = await fetch(url).then(r=>r.json());
      messagesEl.innerHTML = '';
      for (const m of data) {
        const from = m.from || m.From;
        const text = m.text || m.Text;
        const ts = m.timestampUtc || m.TimestampUtc;
        appendMessage(from, text, ts, from === currentUser);
      }
    }

    document.getElementById('joinGroupBtn').addEventListener('click', async ()=>{
      const g = document.getElementById('groupInput').value.trim();
      if (!g) return alert('Enter group name');
      await connection.invoke('JoinGroup', g);
      await loadLists();
      selectGroup(g);
    });

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', (e)=>{
      if (e.key==='Enter'){ e.preventDefault(); sendMessage(); return; }
      notifyTyping();
    });

    async function sendMessage(){
      const text = document.getElementById('messageInput').value.trim();
      if (!text) return;
      if (selectedTarget.type === 'public') await connection.invoke('SendMessageToAll', text);
      else if (selectedTarget.type === 'user') await connection.invoke('SendPrivateMessage', selectedTarget.name, text);
      else if (selectedTarget.type === 'group') await connection.invoke('SendMessageToGroup', selectedTarget.name, text);
      document.getElementById('messageInput').value = '';
    }

    let typingTimeout = null;
    function notifyTyping(){
      if (!connection) return;
      if (selectedTarget.type === 'user') connection.invoke('TypingToUser', selectedTarget.name).catch(()=>{});
      else if (selectedTarget.type === 'group') connection.invoke('TypingToGroup', selectedTarget.name).catch(()=>{});
      showTyping('You are typing...');
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(()=> typingEl.textContent = '', 1200);
    }

    init().catch(err => console.error(err));
    </script>
</body>
</html>
